{% extends 'evs_index.html' %}
{% block page_name %}
<h5><i class='bx bx-home-alt'></i>Tally</h5>
{% endblock page_name %}


{% block content %}

<div class="content">
    <!-- TOOLBAR -->
    <div class="toolbar">
        <div class="controls">
            <form action="{% url 'evs:Tally' %}" class="search-form">
                <button>Filters:</button>
                <input id="student_name" name="student_name" type="text" placeholder="Search Student Name" value="{{ request.GET.student_name|default:'' }}">
                <input id="student_id" name="student_id" type="text" placeholder="Search Student ID" value="{{ request.GET.student_id|default:'' }}">
                <button type="submit" id='tallySearch'>Search</button>
                {% if request.GET.student_name or request.GET.student_id %}
                    <a href="{% url 'evs:Tally' %}"><button type="button">Clear</button></a>
                {% endif %}
            </form>
        </div>
    </div>
    <!-- TABLE -->
    <div class="table-responsive" style="overflow-x: auto; width: 100%;">
        <table class="table text-center" id='tally'>
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>ID Violation</th>
                    <th>Dress Code</th>
                    <th>Uniform Violation</th>
                    <th>ID Not Claimed</th>
                    <th>Community Service</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for violation in student_violations %}
                <tr>
                    <td>{{ violation.student.last_name }}, {{ violation.student.first_name }} {{ violation.student.middle_name }}</td>
                    <td>{{ violation.student.student_id }}</td>
                    <td>{{ violation.id_violation_count }}</td>
                    <td>{{ violation.dress_code_count }}</td>
                    <td>{{ violation.uniform_count }}</td>
                    <td>{{ violation.id_not_claimed_count}}
                    <td {% if violation.community_service_status == -1  %} class="status-pending"
                        {% elif violation.community_service_status == 0 %} class="status-resolved"
                        {% else %} class="status-cleared" {% endif %}>
                        {% if violation.community_service_status == 1 %}
                            <span class="status status-awaiting">Awaiting</span>
                        {% elif violation.community_service_status == 0 %}
                            <span class="status status-completed">Completed</span>
                        {% elif violation.community_service_status == -1 %}
                            <span class="status status-not-required">Not Required</span>
                        {% endif %}
                    </td>
                    <td>
                        <div>
                            <form action="{% url 'evs:TallyDetails' violation.student.student_id %}">
                                <button class="controls-unclaimed">View/Edit</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">No violation records found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="pagination">
        <ul>
            {% if student_violations.has_previous %}
            <li><a href="{% url 'evs:TallyDetails' %}?page={{ student_violations.previous_page_number }}{% if request.GET.student_name %}&student_name={{ request.GET.student_name }}{% endif %}{% if request.GET.student_id %}&student_id={{ request.GET.student_id }}{% endif %}">&laquo; Previous</a></li>
            {% else %}
            <li class="disabled"><span>&laquo; Previous</span></li>
            {% endif %}
            
            {% for i in student_violations.paginator.page_range %}
                {% if student_violations.number == i %}
                    <li class="active"><span>{{ i }}</span></li>
                {% else %}
                    <li><a href="{% url 'evs:TallyDetails' %}?page={{ i }}{% if request.GET.student_name %}&student_name={{ request.GET.student_name }}{% endif %}{% if request.GET.student_id %}&student_id={{ request.GET.student_id }}{% endif %}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}
            
            {% if student_violations.has_next %}
            <li><a href="{% url 'evs:TallyDetails' %}?page={{ student_violations.next_page_number }}{% if request.GET.student_name %}&student_name={{ request.GET.student_name }}{% endif %}{% if request.GET.student_id %}&student_id={{ request.GET.student_id }}{% endif %}">Next &raquo;</a></li>
            {% else %}
            <li class="disabled"><span>Next &raquo;</span></li>
            {% endif %}
        </ul>
    </div>
</div>
{% endblock content %}
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('tally');
        const headers = table.querySelectorAll('th');
        let sortDirection = 1; // 1 = asc, -1 = desc
        let currentSortedColumn = -1;
    
        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                if (currentSortedColumn === index) {
                    sortDirection *= -1; // Toggle direction
                } else {
                    sortDirection = 1; // Default to ascending
                    currentSortedColumn = index;
                }
    
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'))
                    .filter(row => row.querySelectorAll('td').length > 0); // Ignore empty or no-data rows
    
                rows.sort((a, b) => {
                    const cellA = a.querySelectorAll('td')[index].innerText.trim().toLowerCase();
                    const cellB = b.querySelectorAll('td')[index].innerText.trim().toLowerCase();
    
                    // Try to compare as numbers first
                    const numA = parseFloat(cellA);
                    const numB = parseFloat(cellB);
    
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return (numA - numB) * sortDirection;
                    }
    
                    return cellA.localeCompare(cellB) * sortDirection;
                });
    
                // Clear existing rows
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    });

    document.getElementById('tallySearch').addEventListener('click', function(){

    })
</script>
{% endblock scripts%}