{% extends "system/settings.html" %}
{% block settings_content %}
<div class="col-md-9 col-lg-10 d-flex flex-column ps-4" style="padding: 32px 0;">
{% for message in messages %}
    <p>{{ message }}</p>
{% endfor %}
    <!-- Add New Academic Year -->
    <div class="card mb-4" style="width: 100%; max-width: 900px;">
        <div class="card-body">
            <h5 class="card-title mb-3" style="color: #19387E; font-weight:900;">Add New Academic Year</h5>

            <!--FORMS HERE-->
           <form id="addAcademicYearForm" method='POST' action="{% url 'evs:AcademicYear' %}">
            {% csrf_token %}
               <div class="row mb-3">
                   <div class="col">
                       <label class="form-label">Academic Year Label <span class="text-danger">*</span></label>
                       <input type="text" class="form-control" id="ayLabel" name="ayLabel" placeholder="Sample: '2025-2026'" required>
                        <div class="invalid-feedback">Academic Year Label is required.</div>
                                          </div>
                                          <div class="col">
                                              <label class="form-label">Semester <span class="text-danger">*</span></label>
                                              <select class="form-select" name="aySem" id="aySem" required>
                                                  {% for semester in semesters %}
                                                        <option value='{{ semester.semester_id }}'>{{ semester.semester }}</option>
                                                  {% endfor %}
                                              </select>
                        <div class="invalid-feedback">Semester is required.</div>
                                          </div>
                                      </div>
                                      <div class="row mb-3">
                                          <div class="col">
                                              <label class="form-label">Date Start<span class="text-danger">*</span></label>
                                              <input type="date" class="form-control" id="ayStart" name="ayStart" required>
                        <div class="invalid-feedback">Start Date is required.</div>
                   </div>
                   <div class="col">
                       <label class="form-label">Date End <span class="text-danger">*</span></label>
                       <input type="date" class="form-control" id="ayEnd" name="ayEnd" required>
                        <div class="invalid-feedback">End Date is required.</div>
                   </div>
               </div>
               <div class="d-flex justify-content-between align-items-center mb-3">
                   <div>
                       <div class="form-check">
                           <input class="form-check-input" type="checkbox" id="setActive" name="setActive" checked>
                           <label class="form-check-label" for="setActive">Set as Active</label>
                       </div>
                   </div>
                   <button type="submit" class="btn btn-outline-primary btn-sm">Add Year</button>
               </div>
           </form>

        </div>
    </div>
    <!-- Academic Years History -->
    <div class="card" style="width: 100%; max-width: 900px;">
        <div class="card-body">
            <h5 class="card-title mb-3" style="color: #19387E; font-weight:900;">Academic Years History</h5>
            <div class="table-responsive">
                <table class="table text-center">
                    <thead>
                        <tr> <!--Table Header LABEL-->
                            <th>Academic Year</th> 
                            <th>Semester</th>
                            <th>Status</th>
                            <th>Date Start</th>
                            <th>Date End</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="academicYearsTbody">
                        {% for item in ay %}
                          <tr>
                              <td>{{ item.description }}</td>
                              <td>{% for semester in semesters %}{% if item.semester == semester.semester_id%}{{semester.semester}}{% endif %}{% endfor %}</th>
                              <td>{% if item.active == 1 %}<span class="badge bg-success">Active</span>
                                {% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</td>
                              <td>{{ item.year_start }}</td>
                              <td>{{ item.year_end }}</td>
                              <td>
                                {% if item.active == 1 %}
                                  <button type="button" class="toggle-status badge bg-danger" data-id="{{ item.acad_year_id }}" data-active="0">
                                    Deactivate
                                  </button>
                                {% else %}
                                  <button type="button" class="toggle-status badge bg-success" data-id="{{ item.acad_year_id }}" data-active="1">
                                    Activate
                                  </button>
                                {% endif %}
                              </td>
                            {% endfor %}
                    </tbody>
                </table>
                <div>
                  <ul class="pagination">
                    {% if ay.has_previous %}
                        <li>
                            <a href="?page={{ ay.previous_page_number }}">&laquo; Previous</a>
                        </li>
                    {% else %}
                        <li class="disabled"><span>&laquo; Previous</span></li>
                    {% endif %}
                    {% for i in ay.paginator.page_range %}
                        {% if ay.number == i %}
                            <li class="active"><span>{{ i }}</span></li>
                        {% else %}
                            <li><a href="?page={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}
                    {% if ay.has_next %}
                        <li>
                            <a href="?page={{ ay.next_page_number }}">Next &raquo;</a>
                        </li>
                    {% else %}
                        <li class="disabled"><span>Next &raquo;</span></li>
                    {% endif %}
                  </ul>
                </div>
            </div>
        </div>
    </div>
  </div>
</div>
  <script>
    document.querySelectorAll('.toggle-status').forEach(button => {
      button.addEventListener('click', function () {
        const id = this.getAttribute('data-id');
        const newStatus = this.getAttribute('data-active');
    
        fetch('/xu-entry-violation/settings/academic-year', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken(),
          },
          body: JSON.stringify({
            id: id,
            active: newStatus,
          }),
        })
        .then(response => {
          if (!response.ok) {
            throw new Error("Failed to update status.");
          }
          return response.json();  // Parse the JSON response
        })
        .then(data => {
          if (data.success) {
            alert(`${data.description} status updated.`);
            window.location.href = "{% url 'evs:AcademicYear' %}";
          } else {
            alert("Update failed: " + (data.error || "Unknown error"));
          }
        })
        .catch(error => {
          alert(error.message);
        });
      })
    });
  
  function getCSRFToken() {
      const token = document.querySelector('meta[name="csrf-token"]');
      return token ? token.getAttribute('content') : '';
  }
  </script>
{% endblock %}