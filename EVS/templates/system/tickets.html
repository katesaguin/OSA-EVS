{% extends 'evs_index.html' %}
{% block title %}
<title>XU OSA - Tickets</title>
{% endblock title %}
{% block page_name %}
<h5><i class='bx bx-home-alt'></i>Tickets</h5>
{% endblock page_name %}
{% block content %}
<div class="content">
    <!-- TOOLBAR -->
    <div class="controls">
        <form action="{% url 'evs:ViolationTickets' %}" class="search-form">
            <button>Filters:</button>
            <input id="filter_date" name="filter_date" type="date" value="{{ request.GET.filter_date|default:'' }}">
            <input id="student_name" name="student_name" type="text" placeholder="Search Student Name" value="{{ request.GET.student_name|default:'' }}">
            <input id="student_id" name="student_id" type="text" placeholder="Search Student ID" value="{{ request.GET.student_id|default:'' }}">
            <button type="submit" id="dashboardSearch">Search</button>
            {% if request.GET.student_name or request.GET.student_id or request.GET.filter_date %}
                <a href="{% url 'evs:ViolationTickets' %}"><button type="button">Clear</button></a>
            {% endif %}
        </form>
    </div>
    <!-- TABLE -->
    <div class="table-responsive" style="overflow-x: auto; width: 100%;">
        <table class="table text-center" id="tickets">
            <thead>
                <tr>
                    <th>Ticket #</th>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>Violation Type</th>
                    <th>Date/Time</th>
                    <th>Ticket Status</th>
                    <th>ID Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="ticket-table-body">
                {% for ticket in tickets %}
                <tr>
                    <td>{{ ticket.ticket_id }}</td>
                    <td>{{ ticket.student.last_name }}, {{ ticket.student.first_name }} {{ ticket.student.middle_name }}</td>
                    <td>{{ ticket.student.student_id }}</td>
                    <td>
                        {% if ticket.uniform_violation %}Uniform Violation<br> {% endif %}
                        {% if ticket.dress_code_violation %}Dress Code Violation<br> {% endif %}
                        {% if ticket.id_violation %}ID Violation<br> {% endif %}
                        {% if ticket.id_not_claimed_violation %}ID Not Claimed Violation{% endif %}
                    </td>
                    <td>{{ ticket.date_created }}</td>
                    <td {% if ticket.ticket_status != 1 and ticket.ticket_status != 2 %} class="status-pending"
                        {% elif ticket.ticket_status != 0 and ticket.ticket_status != 2 %} class="status-resolved"
                        {% else %} class="status-cleared" {% endif %}>
                        {% if ticket.ticket_status != 1 and ticket.ticket_status != 2 %} Pending
                        {% elif ticket.ticket_status != 0 and ticket.ticket_status != 2 %} Resolved 
                        {% else %} Cleared {% endif %}
                    </td>
                    <td>
                        {% if ticket.id_status == 0 %}
                            <form method="POST" action="/xu-entry-violation/ticket/{{ ticket.ticket_id }}/update/id-status">
                                {% csrf_token %}
                                <input type="hidden" name="status" value="1">
                                <button type="submit" class="controls-unclaimed" {% if ticket.ticket_status == 0 %} disabled {% endif %}>Unclaimed</button>
                            </form>
                        {% else %}
                            <button type="button" class="controls-claimed" disabled>Claimed</button>
                        {% endif %}
                    </td>
                    <td>
                        <div>
                            <form action="{% url 'evs:TicketDetails' ticket.ticket_id %}">
                                <button class="controls-unclaimed">View/Edit</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7">No tickets found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
<div class="pagination">
    <ul>
        {% if tickets.has_previous %}
        <li><a href="{% url 'evs:ViolationTickets' %}?page={{ tickets.previous_page_number }}{% if request.GET.student_name %}&student_name={{ request.GET.student_name }}{% endif %}{% if request.GET.student_id %}&student_id={{ request.GET.student_id }}{% endif %}">&laquo; Previous</a></li>
        {% else %}
        <li class="disabled"><span>&laquo; Previous</span></li>
        {% endif %}
        
        {% for i in tickets.paginator.page_range %}
            {% if tickets.number == i %}
                <li class="active"><span>{{ i }}</span></li>
            {% else %}
                <li><a href="{% url 'evs:ViolationTickets' %}?page={{ i }}{% if request.GET.student_name %}&student_name={{ request.GET.student_name }}{% endif %}{% if request.GET.student_id %}&student_id={{ request.GET.student_id }}{% endif %}">{{ i }}</a></li>
            {% endif %}
        {% endfor %}
        
        {% if tickets.has_next %}
        <li><a href="{% url 'evs:ViolationTickets' %}?page={{ tickets.next_page_number }}{% if request.GET.student_name %}&student_name={{ request.GET.student_name }}{% endif %}{% if request.GET.student_id %}&student_id={{ request.GET.student_id }}{% endif %}">Next &raquo;</a></li>
        {% else %}
        <li class="disabled"><span>Next &raquo;</span></li>
        {% endif %}
    </ul>
</div>
{% endblock content %}
{% block scripts%}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('tickets');
        const headers = table.querySelectorAll('th');
        let sortDirection = 1; // 1 = asc, -1 = desc
        let currentSortedColumn = -1;
    
        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => {
                if (currentSortedColumn === index) {
                    sortDirection *= -1; // Toggle direction
                } else {
                    sortDirection = 1; // Default to ascending
                    currentSortedColumn = index;
                }
    
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'))
                    .filter(row => row.querySelectorAll('td').length > 0); // Ignore empty or no-data rows
    
                rows.sort((a, b) => {
                    const cellA = a.querySelectorAll('td')[index].innerText.trim().toLowerCase();
                    const cellB = b.querySelectorAll('td')[index].innerText.trim().toLowerCase();
    
                    // Try to compare as numbers first
                    const numA = parseFloat(cellA);
                    const numB = parseFloat(cellB);
    
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return (numA - numB) * sortDirection;
                    }
    
                    return cellA.localeCompare(cellB) * sortDirection;
                });
    
                // Clear existing rows
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    });

    function getFilterParams() {
        const studentName = document.getElementById('student_name').value;
        const studentId = document.getElementById('student_id').value;
        const filterDate = document.getElementById('filter_date').value;
    
        const params = new URLSearchParams();
        if (studentName) params.append('student_name', studentName);
        if (studentId) params.append('student_id', studentId);
        if (filterDate) params.append('filter_date', filterDate);
        return params.toString();
    }
    
    function refreshTicketTable() {
        const baseUrl = "{% url 'evs:ViolationTable' %}";
        const queryString = getFilterParams();
        const url = `${baseUrl}?${queryString}`;
    
        fetch(url)
            .then(response => response.json())
            .then(data => {
                document.getElementById("ticket-table-body").innerHTML = data.html;
            })
            .catch(error => console.error("Error loading table:", error));
    }

    // Auto-refresh every 30 seconds
    setInterval(refreshTicketTable, 30000);

    // Refresh once on page load
    window.addEventListener("DOMContentLoaded", refreshTicketTable);
</script>
{% endblock scripts%}
